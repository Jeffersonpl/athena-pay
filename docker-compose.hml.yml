version: "3.9"
services:
  postgres:
    image: postgres:16
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    ports: ["5432:5432"]
    volumes: [ "pgdata:/var/lib/postgresql/data" ]

  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    command: start-dev --import-realm
    environment:
      - KEYCLOAK_ADMIN=keycloak
      - KEYCLOAK_ADMIN_PASSWORD=keycloak
    volumes:
      - ./infra/keycloak/realm-athena.json:/opt/keycloak/data/import/realm-athena.json
    ports: ["8081:8080"]

  traefik:
    image: traefik:v2.11
    command:
      - --providers.docker=true
      - --entrypoints.web.address=:80
    ports: ["80:80"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./infra/traefik/traefik.yaml:/traefik.yml

  api-gateway:
    build: ./services/api-gateway
    environment:
      - JWT_ISSUER=${JWT_ISSUER}
      - GATEWAY_AUDIENCE=${GATEWAY_AUDIENCE}
    ports: ["8080:8080"]
    labels:
      - traefik.http.routers.gateway.rule=PathPrefix(`/`)
      - traefik.http.middlewares.ratelimit.rateLimit.average=20
      - traefik.http.middlewares.ratelimit.rateLimit.burst=100
      - traefik.http.routers.gateway.middlewares=ratelimit

  customer-service: { build: ./services/customer-service }
  accounts-service:
    build: ./services/accounts-service
    environment: [ "ENV=${ENV}" ]

  payments-service:
    build: ./services/payments-service
    environment:
      - ACCOUNTS_URL=${ACCOUNTS_URL}
      - TOKEN_VAULT_BASE=${TOKEN_VAULT_BASE}
      - TOKEN_VAULT_KEY=${TOKEN_VAULT_KEY}

  pix-service:
    build: ./services/pix-service
    environment:
      - ACCOUNTS_URL=${ACCOUNTS_URL}
      - PIX_PROVIDER_BASE=${PIX_PROVIDER_BASE}

  wire-service:
    build: ./services/wire-service
    environment:
      - ACCOUNTS_URL=${ACCOUNTS_URL}

  kyc-service:
    build: ./services/kyc-service
    environment:
      - ENV=${ENV}
      - KYC_PROVIDER_BASE=${KYC_PROVIDER_BASE}

  fx-crypto-service:
    build: ./services/fx-crypto-service
    environment:
      - COINBASE_COMMERCE_WEBHOOK_SECRET=${COINBASE_COMMERCE_WEBHOOK_SECRET}

  statement-service:
    build: ./services/statement-service
    environment:
      - JWT_ISSUER=${JWT_ISSUER}
      - GATEWAY_AUDIENCE=${GATEWAY_AUDIENCE}
      - ACCOUNTS_URL=${ACCOUNTS_URL}
    ports: ["9091:8080"]

  admin-api: { build: ./services/admin-api, ports: ["8082:8080"] }
  whatsapp-service: { build: ./services/whatsapp-service, ports: ["9090:8080"] }
  boleto-service: { build: ./services/boleto-service }
  loans-service: { build: ./services/loans-service }
  rewards-service: { build: ./services/rewards-service }
  affiliates-service: { build: ./services/affiliates-service }
  accounting-service: { build: ./services/accounting-service }
  compliance-service: { build: ./services/compliance-service }

  web: { build: ./apps/web, ports: ["5174:5174"] }
  admin: { build: ./apps/admin, ports: ["5173:5173"] }
  # mobile: rode local com expo (apps/mobile)
volumes: { pgdata: {} }
